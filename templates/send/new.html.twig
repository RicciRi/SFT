{# templates/file_transfer/send.html.twig #}

{% extends 'base.html.twig' %}

{% block title %}{{ parent() }} - Send file{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
{% endblock %}

{% block body %}
    <div class="send-file-container-wrap">
        <div class="send-file-container left-side">
            <div id="upload-section" class="upload-section">
                <div id="dropzone" class="dropzone">
                    <label for="file-input">
                        <div class="upload-icon">
                            <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 640 512"
                                 height="40px" width="40px" xmlns="http://www.w3.org/2000/svg">
                                <path d="M144 480C64.5 480 0 415.5 0 336c0-62.8 40.2-116.2 96.2-135.9c-.1-2.7-.2-5.4-.2-8.1c0-88.4 71.6-160 160-160c59.3 0 111 32.2 138.7 80.2C409.9 102 428.3 96 448 96c53 0 96 43 96 96c0 12.2-2.3 23.8-6.4 34.6C596 238.4 640 290.1 640 352c0 70.7-57.3 128-128 128l-368 0zm79-217c-9.4 9.4-9.4 24.6 0 33.9s24.6 9.4 33.9 0l39-39L296 392c0 13.3 10.7 24 24 24s24-10.7 24-24l0-134.1 39 39c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-80-80c-9.4-9.4-24.6-9.4-33.9 0l-80 80z"></path>
                            </svg>
                        </div>
                        <p>Drag and drop files here or <span class="browse-text">browse files</span></p>
                        <p class="small-text">or drag an entire folder</p>
                    </label>
                    <input type="file" id="file-input" multiple style="display: none">
                </div>
                <div id="upload-progress" class="progress" style="display: none;">
                    <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
            </div>

            <div class="form-section">
                <form id="transfer-form">
                    <div class="form-group">
                        <label for="recipient-email">Recipient Email</label>
                        <input type="email" id="recipient-email" name="recipientEmail" class="form-control"
                               placeholder="email@example.com" required>
                    </div>

                    <div class="form-group">
                        <label for="subject">Subject</label>
                        <input type="text" id="subject" name="subject" class="form-control" placeholder="Email subject"
                               required>
                    </div>

                    <div class="form-group">
                        <label for="message">Message</label>
                        <textarea id="message" name="message" class="form-control" rows="5"
                                  placeholder="Enter your message..." required></textarea>
                    </div>

                    <div class="form-actions">
                        <button type="submit" id="submit-btn" class="btn-submit" disabled>
                            Send Files <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </form>
            </div>

            <div id="error-message" class="message message-error" style="display: none;"></div>
            <div id="success-message" class="message message-success" style="display: none;"></div>
        </div>
        <div class="right-side send-file-container">
            <div id="file-list-container" class="file-list" style="display: none;">
                <div class="file-count">Uploaded Files <span class="badge" id="file-count">0</span></div>
                <ul id="file-list"></ul>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const dropzone = document.getElementById('dropzone');
            const fileInput = document.getElementById('file-input');
            const fileList = document.getElementById('file-list');
            const fileListContainer = document.getElementById('file-list-container');
            const fileCount = document.getElementById('file-count');
            const uploadProgress = document.getElementById('upload-progress');
            const progressBar = uploadProgress.querySelector('.progress-bar');
            const transferForm = document.getElementById('transfer-form');
            const submitBtn = document.getElementById('submit-btn');

            let uploadedFiles = [];

            // Очищаем сессию при загрузке страницы
            resetFilesSession();

            // Функция для сброса сессии на сервере
            function resetFilesSession() {
                fetch('{{ path('api_reset_files') }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => response.json())
                    .catch(error => console.error('Error resetting files session:', error));
            }

            // Обработчик выбора файлов через input
            fileInput.addEventListener('change', function () {
                handleFiles(Array.from(this.files));
            });

            // Обработчики перетаскивания файлов
            dropzone.addEventListener('dragover', function (e) {
                e.preventDefault();
                dropzone.classList.add('active');
            });

            dropzone.addEventListener('dragleave', function () {
                dropzone.classList.remove('active');
            });

            dropzone.addEventListener('drop', function (e) {
                e.preventDefault();
                dropzone.classList.remove('active');

                const items = e.dataTransfer.items;
                const files = e.dataTransfer.files;

                // Если перетаскиваются файлы напрямую
                if (files.length > 0 && (!items[0].webkitGetAsEntry)) {
                    handleFiles(Array.from(files));
                    return;
                }

                // Обработка каталогов (только для поддерживаемых браузеров)
                if (items.length > 0 && items[0].webkitGetAsEntry) {
                    const entries = [];
                    for (let i = 0; i < items.length; i++) {
                        const entry = items[i].webkitGetAsEntry();
                        if (entry) {
                            entries.push(entry);
                        }
                    }

                    processEntries(entries);
                }
            });

            // Рекурсивная функция для обработки каталогов
            function processEntries(entries) {
                const allFiles = [];
                let pendingDirectories = entries.length;

                const allEntriesProcessed = () => {
                    if (allFiles.length > 0) {
                        handleFiles(allFiles);
                    }
                };

                const processEntry = (entry) => {
                    if (entry.isFile) {
                        entry.file(file => {
                            allFiles.push(file);

                            if (--pendingDirectories === 0) {
                                allEntriesProcessed();
                            }
                        });
                    } else if (entry.isDirectory) {
                        const reader = entry.createReader();

                        // Чтение всех элементов в директории
                        const readEntries = () => {
                            reader.readEntries(entries => {
                                if (entries.length) {
                                    pendingDirectories += entries.length - 1;
                                    entries.forEach(processEntry);
                                    readEntries(); // Продолжаем чтение, так как API может возвращать по частям
                                } else if (--pendingDirectories === 0) {
                                    allEntriesProcessed();
                                }
                            });
                        };

                        readEntries();
                    }
                };

                entries.forEach(processEntry);
            }

            // Обработка файлов для загрузки
            function handleFiles(files) {
                if (files.length === 0) return;

                uploadFiles(files);
            }

            // Функция загрузки файлов на сервер
            async function uploadFiles(files) {
                uploadProgress.style.display = 'block';

                const formData = new FormData();
                for (let i = 0; i < files.length; i++) {
                    formData.append('files[]', files[i]);
                }

                try {
                    const xhr = new XMLHttpRequest();
                    xhr.open('POST', '{{ path('api_upload_files') }}');

                    xhr.upload.addEventListener('progress', function (e) {
                        if (e.lengthComputable) {
                            const percentComplete = (e.loaded / e.total) * 100;
                            progressBar.style.width = percentComplete + '%';
                        }
                    });

                    xhr.onload = function () {
                        if (xhr.status === 200) {
                            const response = JSON.parse(xhr.responseText);

                            if (response.success) {
                                // Обновляем только массив uploadedFiles на фронтенде
                                uploadedFiles = [...uploadedFiles, ...response.files];
                                updateFileList();
                                submitBtn.disabled = uploadedFiles.length === 0;
                            } else {
                                showFlash('error', response.error || 'Error uploading files')
                            }
                        } else {
                            showFlash('error', 'Server error: ' + xhr.status)
                        }

                        uploadProgress.style.display = 'none';
                    };

                    xhr.onerror = function () {
                        showFlash('error', 'Connection error')
                        uploadProgress.style.display = 'none';
                    };

                    xhr.send(formData);
                } catch (error) {
                    showFlash('error', 'Error sending request to server')
                    uploadProgress.style.display = 'none';
                }
            }

            // Обновление списка загруженных файлов
            function updateFileList() {
                if (uploadedFiles.length > 0) {
                    fileListContainer.style.display = 'block';
                    fileCount.textContent = uploadedFiles.length;

                    fileList.innerHTML = '';
                    uploadedFiles.forEach((file, index) => {
                        const li = document.createElement('li');
                        li.className = 'file-item fade-in';

                        li.innerHTML = `
                        <div class="file-icon">
                            <i class="${getFileIcon(file.mimeType)}"></i>
                        </div>
                        <div class="file-info">
                            <div class="file-name">${file.originalFilename}</div>
                            <div class="file-meta">${file.fileSize} &middot; ${getFileType(file.mimeType)}</div>
                        </div>
                        <button type="button" class="remove-btn" data-index="${index}" data-token="${file.sessionToken}">
                            <i class="fas fa-times"></i>
                        </button>
                    `;

                        fileList.appendChild(li);
                    });

                    // Добавляем обработчики для кнопок удаления
                    document.querySelectorAll('.remove-btn').forEach(btn => {
                        btn.addEventListener('click', function () {
                            const index = parseInt(this.dataset.index);
                            const token = this.dataset.token;
                            removeFile(index, token);
                        });
                    });
                } else {
                    fileListContainer.style.display = 'none';
                }
            }

            // Удаление файла из списка
            function removeFile(index, token) {
                // Удаляем файл из локального массива
                uploadedFiles.splice(index, 1);
                updateFileList();
                submitBtn.disabled = uploadedFiles.length === 0;

                // Удаляем файл из сессии на сервере
                fetch(`/send/api/remove-file/${token}`, {
                    method: 'DELETE'
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log('File removed from session', data);
                    })
                    .catch(error => {
                        console.error('Error removing file from session:', error);
                    });
            }

            // Отправка формы с данными о файлах
            transferForm.addEventListener('submit', async function (e) {
                e.preventDefault();

                if (uploadedFiles.length === 0) {
                    showFlash('error', 'At least one file must be uploaded')
                    return;
                }

                const formData = {
                    recipientEmail: document.getElementById('recipient-email').value,
                    subject: document.getElementById('subject').value,
                    message: document.getElementById('message').value
                };

                if (!formData.recipientEmail || !formData.subject || !formData.message) {
                    showFlash('error', 'Please fill in all required form fields')
                    return;
                }
                submitBtn.disabled = true;
                submitBtn.innerHTML = 'Sending... <i class="fas fa-spinner fa-spin"></i>';

                try {
                    const response = await fetch('{{ path('api_file_transfer_create') }}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });

                    const result = await response.json();

                    if (response.ok) {
                        showFlash('success', 'Files sent successfully! The recipient will be notified via email.')
                        uploadedFiles = [];
                        updateFileList();
                        transferForm.reset();
                    } else {
                        showFlash('error', result.error || 'Error creating file transfer')
                        submitBtn.disabled = false;
                    }
                } catch (error) {
                    showFlash('error', 'Error sending request to server')
                    submitBtn.disabled = false;
                } finally {
                    submitBtn.innerHTML = 'Send Files <i class="fas fa-paper-plane"></i>';
                    submitBtn.disabled = uploadedFiles.length === 0;
                }
            });

            function getFileIcon(mimeType) {
                if (mimeType.startsWith('image/')) return 'fas fa-file-image';
                if (mimeType.startsWith('video/')) return 'fas fa-file-video';
                if (mimeType.startsWith('audio/')) return 'fas fa-file-audio';
                if (mimeType === 'application/pdf') return 'fas fa-file-pdf';
                if (mimeType.includes('spreadsheet') || mimeType.includes('excel')) return 'fas fa-file-excel';
                if (mimeType.includes('document') || mimeType.includes('word')) return 'fas fa-file-word';
                if (mimeType.includes('presentation') || mimeType.includes('powerpoint')) return 'fas fa-file-powerpoint';
                if (mimeType === 'application/zip' || mimeType === 'application/x-zip-compressed') return 'fas fa-file-archive';

                return 'fas fa-file';
            }

            function getFileType(mimeType) {
                const types = {
                    'image/': 'Image',
                    'video/': 'Video',
                    'audio/': 'Audio',
                    'application/pdf': 'PDF',
                    'application/zip': 'Archive',
                    'application/x-zip-compressed': 'Archive',
                    'application/msword': 'Word',
                    'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'Word',
                    'application/vnd.ms-excel': 'Excel',
                    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': 'Excel',
                    'application/vnd.ms-powerpoint': 'PowerPoint',
                    'application/vnd.openxmlformats-officedocument.presentationml.presentation': 'PowerPoint'
                };

                for (const [key, value] of Object.entries(types)) {
                    if (mimeType === key || mimeType.startsWith(key)) {
                        return value;
                    }
                }

                return 'File';
            }
        });
    </script>
{% endblock %}